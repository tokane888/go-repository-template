---
pre-commit:
  commands:
    # コミットは使用頻度が高いためgolangci-lintは実行しない
    dprint-fmt:
      run: |
        files=$(echo "{staged_files}" | tr ' ' '\n' | grep -E '(Dockerfile|\.json|\.md)$' || true)
        if [ -n "$files" ]; then
          echo "$files" # フォーマット対象のファイル名出力(go fmt等では出力されるが、dprintでは出力されないため)
          echo "$files" | xargs -r dprint fmt
        fi
      stage_fixed: true

    cspell:
      run: |
        files=$(echo "{staged_files}" | tr ' ' '\n' | grep -E '\.(go|json|yml|yaml)$' || true)
        if [ -n "$files" ]; then
          echo "Spell checking files:"
          echo "$files"
          echo "$files" | xargs -r cspell --no-must-find-files || echo "⚠️  Spelling issues found. Please review and fix if necessary."
        fi
      # エラーがあってもコミットを続行
      fail_text: ""

pre-push:
  commands:
    golangci-lint:
      # モノレポ構造に対応したlint実行
      run: |
        # go.modファイルを持つディレクトリを検索
        modules=$(find ./services ./pkg -name "go.mod" 2>/dev/null | xargs dirname | sort)

        if [ -z "$modules" ]; then
          echo "go.modファイルが見つかりませんでした。"
          exit 0
        fi

        # 各モジュールでgolangci-lintを実行
        has_error=0
        for module in $modules; do
          echo "Running golangci-lint in $module"
          if ! (cd "$module" && golangci-lint run ./...); then
            echo "エラー: $module でgolangci-lintが失敗しました"
            has_error=1
          fi
        done

        # いずれかのモジュールでエラーがあった場合は終了
        if [ $has_error -eq 1 ]; then
          exit 1
        fi
